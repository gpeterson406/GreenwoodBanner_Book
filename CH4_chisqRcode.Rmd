---
title: "CH4"
output:
  word_document:
    fig_width: 10.5
    fig_height: 7
    reference_docx: mystyles.docx 
---

```{r warning=F, message=F, echo=T}



#Chapter 4 R code:

require(vcd)
data(Arthritis) #Double-blind clinical trial with treatment and control groups
#Homogeneity examplereq
require(tabplot)

tableplot(Arthritis,select=c(Treatment,Improved,Sex,Age))
#require(extracat)
#cpcp(Arthritis)
require(mosaic)
tally(~Treatment+Improved,data=Arthritis,margins=T)
tally(~Improved|Treatment,data=Arthritis,format="proportion",margins=T)

plot(Improved~Treatment,data=Arthritis,main="Stacked Bar Chart of Arthritis Data")

Arthtable <- tally(~Treatment+Improved,data=Arthritis)
Arthtable

chisq.test(Arthtable)$expected
(chisq.test(Arthtable)$residuals)^2

sum((chisq.test(Arthtable)$residuals)^2)

chisq.test(Arthtable)

chisq.test(Arthtable)$residuals
mosaicplot(Arthtable,shade=T)

#relative to null model:
ArthritisFAKE <- rbind(Arthritis,Arthritis) # Just to make the following plot!
ArthritisFAKE$Treat<-factor(c(rep("Placebo",84),rep("Treated",84))) #Just to make the following plot
tally(~Improved|Treat,data=ArthritisFAKE,format="proportion",margins=T)
plot(Improved~Treat,data=ArthritisFAKE,main="Homogeneity Null Hypothesis True")

#Permute the group labels once:

Arthperm<-Arthritis
set.seed(98765)
Arthperm$PermTreatment<-factor(shuffle(Arthperm$Treatment))
plot(Improved~PermTreatment,data=Arthperm,main="Stacked Bar Chart of Permuted Arthritis Data")
Arthpermtable<-tally(~PermTreatment+Improved,data=Arthperm,margins=F)
Arthpermtable
chisq.test(Arthpermtable)

set.seed(98765)
Arthperm$PermTreatment<-factor(shuffle(Arthperm$Treatment))
par(mfrow=c(2,2))
plot(Improved~PermTreatment,data=Arthperm,main=expression(paste("X"^"2","=",0.62)))
Arthperm$PermTreatment<-factor(shuffle(Arthperm$Treatment))
Arthpermtable<-tally(~PermTreatment+Improved,data=Arthperm,margins=F)
chisq.test(Arthpermtable)
plot(Improved~PermTreatment,data=Arthperm,main=expression(paste("X"^"2","=",1.62)))

Arthperm$PermTreatment<-factor(shuffle(Arthperm$Treatment))
Arthpermtable<-tally(~PermTreatment+Improved,data=Arthperm,margins=F)
chisq.test(Arthpermtable)
plot(Improved~PermTreatment,data=Arthperm,main=expression(paste("X"^"2","=",0.81)))

Arthperm$PermTreatment<-factor(shuffle(Arthperm$Treatment))
Arthpermtable<-tally(~PermTreatment+Improved,data=Arthperm,margins=F)
chisq.test(Arthpermtable)
plot(Improved~PermTreatment,data=Arthperm,main=expression(paste("X"^"2","=",2.38)))


#Permutation test:

Tobs <- chisq.test(Arthtable)$statistic; Tobs

par(mfrow=c(1,2))
B<- 1000
Tstar<-matrix(NA,nrow=B)
for (b in (1:B)){
  Tstar[b]<-chisq.test(tally(~shuffle(Treatment)+Improved,data=Arthritis,margins=F))$statistic
}
hist(Tstar,xlim=c(0,Tobs+1))
abline(v=Tobs,col="red",lwd=3)
plot(density(Tstar),main="Density curve of Tstar",xlim=c(0,Tobs+1),lwd=2)
abline(v=Tobs,col="red",lwd=3)


pdata(Tstar,Tobs,lower.tail=F)





par(mfrow=c(1,1))
Xsq<-seq(from=0,to=15,length.out=30)
plot(Xsq,dchisq(Xsq,df=2),ylab="Density",main="Plot of Chi-sq(2) distribution",type="l",col="blue",lwd=2)
abline(v=13.055,col="magenta",lwd=3)

pchisq(13.055,df=2,lower.tail=F)


#Independence example 1

require(poLCA)
data(election) #2000 Survey 
require(tabplot)
election$VOTEF<-factor(election$VOTE3)
election$PARTY<-factor(election$PARTY)
election$EDUC<-factor(election$EDUC)
election$SEX<-factor(election$GENDER)
levels(election$VOTEF)<-c("Gore","Bush","Other")
tableplot(election,select=c(VOTEF,PARTY,EDUC,SEX))
#Clean data set
election2<-na.omit(election[,c("VOTEF","PARTY","EDUC","SEX")])
tableplot(election2,select=c(VOTEF,PARTY,EDUC,SEX),sort=1)
tableplot(election2,select=c(VOTEF,PARTY,EDUC,SEX),sort=3)

chisq.test(tally(~VOTEF+EDUC,data=election2))

electable<-tally(~PARTY+VOTEF,data=election2)
tally(~PARTY+VOTEF,data=election2,margins=T)
#Put "predictor" first as ~x+y 
electable
par(mfrow=c(1,1))
mosaicplot(electable) #Makes a mosaic plot where areas are related to the proportion of the total in the table

chisq.test(electable)$expected

chisq.test(electable)

mosaicplot(electable,shade=T) #Adds information on the size of the residuals
mosaicplot(VOTEF~PARTY,data=election2,shade=T)
chisq.test(electable)$residuals #(Obs-expected)/sqrt(expected)
mosaicplot(chisq.test(electable)$expected)


mosaicplot(chisq.test(electable)$expected,main="Plot of H0: Independence True")

#plot(INTELG~factor(PARTY),data=election2)

Xsq<-seq(from=0,to=100,length.out=100)
plot(Xsq,dchisq(Xsq,df=12),ylab="Density",main="Plot of Chi-sq(12) distribution",type="l",col="blue",lwd=2)

pchisq(762.81,df=12,lower.tail=F)

Tobs <- chisq.test(electable)$statistic; Tobs

par(mfrow=c(1,2))
B<- 1000
Tstar<-matrix(NA,nrow=B)
for (b in (1:B)){
  Tstar[b]<-chisq.test(tally(~shuffle(PARTY)+VOTEF,data=election2,margins=F))$statistic
}
hist(Tstar)
abline(v=Tobs,col="red",lwd=3)
plot(density(Tstar),main="Density curve of Tstar",lwd=2)
abline(v=Tobs,col="red",lwd=3)


pdata(Tstar,Tobs,lower.tail=F)



data(cheating) #Survey of students
#Create new response variable based on combinations of lieing to avoid exam or paper
#
par(mfrow=c(1,1))
require(tabplot)
cheating$LIEEXAM<-factor(cheating$LIEEXAM)
cheating$LIEPAPER<-factor(cheating$LIEPAPER)
cheating$FRAUD<-factor(cheating$FRAUD)
cheating$COPYEXAM<-factor(cheating$COPYEXAM)
cheating$GPA<-factor(cheating$GPA)

tableplot(cheating,sort=GPA)


cheating$liar<-interaction(cheating$LIEEXAM,cheating$LIEPAPER)
levels(cheating$liar)<-c("None","ExamLie","PaperLie","LieBoth")

cheating$copier<-interaction(cheating$FRAUD,cheating$COPYEXAM)
levels(cheating$copier)<-c("None","PaperCheat","ExamCheat","PaperExamCheat")

cheatlietable<-tally(~liar+copier,data=cheating)
cheatlietable

tableplot(cheating,sort=liar,select=c(liar,copier))

mosaicplot(cheatlietable)

#Collapse the middle categories of each variable
cheating$liar2<-cheating$liar
levels(cheating$liar2)<-c("None","ExamorPaper","ExamorPaper","LieBoth")
cheating$copier2<-cheating$copier
levels(cheating$copier2)<-c("None","ExamorPaper","ExamorPaper","CopyBoth")

tableplot(cheating,sort=liar2,select=c(liar2,copier2))
cheatlietable<-tally(~liar2+copier2,data=cheating)
cheatlietable

chisq.test(cheatlietable)$expected

chisq.test(cheatlietable)

pchisq(13.2384,df=4,lower.tail=F)

Xsq<-seq(from=0,to=30,length.out=100)
plot(Xsq,dchisq(Xsq,df=4),ylab="Density",main="Plot of Chi-sq(4) distribution",type="l",col="blue",lwd=2)
abline(v=13.24,col="magenta")


#Permutations to find distribution under H0

Tobs<-chisq.test(tally(~liar2+copier2,data=cheating))$statistic
Tobs

par(mfrow=c(1,2))
B<- 10000
Tstar<-matrix(NA,nrow=B)
for (b in (1:B)){
  Tstar[b]<-chisq.test(tally(~shuffle(liar2)+copier2,data=cheating))$statistic
}
hist(Tstar)
abline(v=Tobs,col="red",lwd=3)
plot(density(Tstar),main="Density curve of Tstar",lwd=2)
abline(v=Tobs,col="red",lwd=3)


pdata(Tstar,Tobs,lower.tail=F)



par(mfrow=c(1,1))
mosaicplot(cheatlietable,shade=T)

chisq.test(cheatlietable)$residuals

#Homogeneity test based on strat random sample of schools of three types from California schools:
#Population data set:
require(survey)
data(api)
require(mosaic)
tally(~stype,data=apipop) #Population counts

tally(~stype,data=apistrat) #Sample counts
#tally(sch.wide~stype,data=apistrat)

#schooltable=tally(~stype+comp.imp,data=apistrat,margins=F)
#schooltable
#chisq.test(schooltable)
require(beanplot)
par(mfrow=c(1,2))
boxplot(growth~stype,data=apistrat,ylab="Growth",ylim=c(-55,160))
beanplot(growth~stype,data=apistrat ,log="",col="beige",method="jitter",ylim=c(-55,160))

#Growth measures the change in schools from 1999 to 2000 in the API (academic performance index)
m1<-lm(growth~stype,data=apistrat)
require(car)
Anova(m1)
par(mfrow=c(1,1))
plot(m1,which=2)


beanplot(residuals(lm(growth~stype,data=apistrat)),method="jitter",log="",col="yellow")

#Cut the quantitative variable into categories 

favstats(~growth,data=apistrat)

apistrat$growthcut<-cut(apistrat$growth,breaks=c(-47,6.75,25,48,133),include.lowest=T)
tally(~growthcut,data=apistrat)

plot(growthcut~stype,data=apistrat)

growthtable<-tally(~stype+growthcut,data=apistrat)
growthtable
chisq.test(growthtable)$expected        
chisq.test(growthtable) 

pchisq(38.668,df=6,lower.tail=F)

chisq.test(growthtable)$residuals
        
mosaicplot(growthcut~stype,data=apistrat,shade=T)        
        
#Association test data:
data(SexualFun) #Already a contengency table
plot(SexualFun)
t1=chisq.test(SexualFun)
t1$expected
 mosaicplot(SexualFun)
 mosaicplot(SexualFun,shade=T)
mosaicplot(t1$expected)

```
